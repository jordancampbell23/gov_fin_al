---
title: "counties"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
county_pop_census_acfrs <- readRDS("data/county_pop_census_acfrs.RDS")

# To map
counties_1 <- county_pop_census_acfrs %>% 
  mutate(lib_rev_ratio = (total_liabilities/revenues)*100,
         percapita = total_liabilities/population) %>% 
  
  #rename cols to match Jordan's original files to display on map
  rename(FIPS = id.y, 
         state_abv = state.abb,  
            state = state.name,
         name = county,
         revenue = revenues
         ) %>%
  
  mutate(FIPS = str_sub(FIPS, -5, -1)) %>% 
  arrange(desc(population)) %>% 
  select(FIPS, state, name, population, total_liabilities, revenue, lib_rev_ratio, percapita, state_abv) %>% arrange(desc(population)) 

```

# Special cases: Combined city/ city government
```{r}
# get from list of cities
cities <- read.csv("cities.csv") %>% 
select(-c(lat, long, X)) %>% rename(name = city, # to match with colnames in counties file
                                 revenue = revenues) 

##Jacksonville city, FL  = Duval County, FL # copy the data for Jacksonville, FL to a new row in the County data for Duval County, FL

jacksonville_duval <- cities %>% 
filter(state_abv == "FL" & name == "Jacksonville") %>% 
mutate(name = ifelse(name == "Jacksonville", "Duval County", name),
         percapita = total_liabilities/population) %>% 

  # adding FIPS code manually
  mutate(FIPS = "12031") # got it here https://www.census.gov/quickfacts/fact/table/duvalcountyflorida,US/PST045221


## San Francisco city, CA = San Francisco County, CA
sanfrancisco <- cities %>% 
filter(state_abv == "CA" & name == "San Francisco") %>% 
  mutate(percapita = total_liabilities/population, 
         FIPS = "06075") 

```


```{r}
#Denver, CO
denver <- cities  %>% 
filter(state_abv == "CO" & name == "Denver") %>% 
  mutate(percapita = total_liabilities/population, 
         FIPS = "08031") 

```


```{r}
#Philadelphia, PA

philadelphia <- cities %>% 
filter(state_abv == "PA" & name == "Philadelphia") %>% 
  mutate(percapita = total_liabilities/population, 
         FIPS = "42101")
```

```{r}
#Indianapolis-Marion County, Indiana
indianapolis_marion <- cities %>% 
filter(state_abv == "IN" & name == "Indianapolis") %>% 
  mutate(percapita = total_liabilities/population, 
         FIPS = "1836003", # Indianapolis city (balance), Indiana
         name = ifelse(name == "Indianapolis", "Indianapolis-Marion County", ""))
```



```{r}
#Nashville, TN and Davidson County, TN
cities %>% filter(str_detect(name, "Nashville"))
# --> Not in list of 100 cities

acfrs_city_pop_added_char <- readRDS("data/acfrs_city_pop_added_char.RDS")
acfrs_city_pop_added_char %>% filter(str_detect(name, "Nashville" ))
#--> No Nashville city TN in the list of matched city and census population 

# check in database for Nashville city
acfrs <- readRDS("data/data_from_dbsite.RDS")

acfrs %>% filter(state == "TN") %>% filter(str_detect(name, "Nashville")) -> nashville

write.csv(nashville, "nashville.csv") # ask Marc: --> which one of these is Nashville city?


```

```{r}
# check other cases that Marc noted
#Louisville-Jefferson County, Kentucky --> FIPS 2148006
cities %>% filter(str_detect(name, "Jefferson")) # --> No Jefferson in list of top 100 cities 

acfrs_city_pop_added_char %>% 
  filter(state.name == "Kentucky") %>% 
  filter(str_detect(name, "Jefferson" )) # Jeffersontown city? 
```

```{r}
counties <- rbind(counties_1, 
                  jacksonville_duval, 
                  sanfrancisco,
                  denver,
                  philadelphia,
                  indianapolis_marion) 

write.csv(counties, "counties.csv")

```

